<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"
      crossorigin
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.1.2/react-router-dom.js"
      crossorigin=""
    ></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>
    <body>
        <div id='root'> </div>
    </body>
    <script type='text/babel'>
        const root = document.getElementById('root');

        const API = 'https://acme-users-api-rev.herokuapp.com/api';

        const fetchUser = async ()=> {
        const storage = window.localStorage;
        const userId = storage.getItem('userId'); 
        if(userId){
            try {
            return (await axios.get(`${API}/users/detail/${userId}`)).data;
            }
            catch(ex){
            storage.removeItem('userId');
            return fetchUser();
            }
        }
        const user = (await axios.get(`${API}/users/random`)).data;
        storage.setItem('userId', user.id);
        return  user;
        };

        class NotesDisplay extends React.Component{
            constructor(props){
                super();
                this.state = {user: props.user, notes: null};
                console.log(this.state);
                
            }
            async componentDidMount(){
                const notes = await axios.get(`https://acme-users-api-rev.herokuapp.com/api/users/${this.state.user.id}/notes`).data;
                this.setState({notes});
            }
            render(){
                if(this.state.notes){
                    return (
                        <ul>
                            {
                                this.state.notes.map(note => 
                            <li key={note.id}>
                            note.text<button>Archieve</button><button>Destroy</button>
                            </li>)
                            }
                        </ul>
                    );
                }
                return <div>Loading...</div>
            }
        }
        
        class APP extends React.Component{
            constructor(){
                super();
                this.state = {user: null};
            }
            async componentDidMount(){
                const user = await fetchUser();
                this.setState({user});
                //console.log(this.state.user);
            }

            render(){
                if(this.state.user){
                    return <div><h1>Acme Note-taker for {this.state.user.fullName}</h1><NotesDisplay user={this.state.user} />
                    <NoteCreate user={this.state.user} />
                    </div>
                }
                return <div>Loading...</div>
            }
        }

        class NoteCreate extends React.Component{
            constructor(props){
                super();
                this.state = {
                    user: props.user, 
                    noteText:''
                    };
                this.updateText = this.updateText.bind(this);
                this.postNote = this.postNote.bind(this);
            }
            render(){
                return(
                    <form onSubmit={this.postNote}>
                        <input type='text' name ='noteText' onChange={this.updateText}/>
                        <button>Create</button>
                    </form>
                );
            }

            updateText(ev){
                this.setState({[ev.target.name]: ev.target.value});
                console.log(this.state.noteText);
            }

            async postNote(ev){
                ev.preventDefault();
                //const newNote = await axios.post(`https://acme-users-api-rev.herokuapp.com/api/users/${this.state.user.id}/notes`, {archived: false, text: `test note text`});
                const newNote = await axios.post(`https://acme-users-api-rev.herokuapp.com/api/users/${this.state.user.id}/notes`, {archived: false, text: this.state.noteText.toString()});
                console.log(newNote);
            }
        }

        ReactDOM.render(<APP />, root);
    </script>
</html>